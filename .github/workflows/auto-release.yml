name: Auto Release

# è‡ªåŠ¨å‘å¸ƒå·¥ä½œæµ - å½“ torrent_maker.py ç‰ˆæœ¬å˜æ›´æ—¶è§¦å‘
on:
  push:
    branches: [ main ]
    paths:
      - 'torrent_maker.py'
  workflow_dispatch:  # æ·»åŠ æ‰‹åŠ¨è§¦å‘é€‰é¡¹
    inputs:
      force_release:
        description: 'å¼ºåˆ¶å‘å¸ƒï¼ˆå³ä½¿ç‰ˆæœ¬å·²å­˜åœ¨ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# è®¾ç½®æƒé™
permissions:
  contents: write
  pull-requests: read

jobs:
  auto-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Extract version and check if release needed
      id: version
      run: |
        # ä» torrent_maker.py æå–ç‰ˆæœ¬å·
        VERSION=$(grep -E '^VERSION\s*=\s*"v[0-9]+\.[0-9]+\.[0-9]+"' torrent_maker.py | sed -E 's/.*"v([0-9]+\.[0-9]+\.[0-9]+)".*/\1/' | head -1)
        
        if [ -z "$VERSION" ]; then
          echo "âŒ æ— æ³•ä» torrent_maker.py æå–ç‰ˆæœ¬å·"
          exit 1
        fi
        
        echo "ğŸ“‹ æ£€æµ‹åˆ°ç‰ˆæœ¬: v$VERSION"
        
        # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨å’Œå¼ºåˆ¶å‘å¸ƒé€‰é¡¹
        FORCE_RELEASE="${{ github.event.inputs.force_release || 'false' }}"
        
        if git tag | grep -q "^v$VERSION$" && [ "$FORCE_RELEASE" != "true" ]; then
          echo "âš ï¸ ç‰ˆæœ¬ v$VERSION å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒï¼ˆä½¿ç”¨ force_release=true å¯å¼ºåˆ¶å‘å¸ƒï¼‰"
          echo "should_release=false" >> $GITHUB_OUTPUT
        else
          if [ "$FORCE_RELEASE" = "true" ]; then
            echo "ğŸ”„ å¼ºåˆ¶å‘å¸ƒæ¨¡å¼ï¼šv$VERSION"
          else
            echo "âœ… æ–°ç‰ˆæœ¬ v$VERSIONï¼Œå‡†å¤‡å‘å¸ƒ"
          fi
          echo "should_release=true" >> $GITHUB_OUTPUT
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Validate torrent_maker.py
      if: steps.version.outputs.should_release == 'true'
      run: |
        echo "ğŸ” éªŒè¯ torrent_maker.py..."
        python3 -m py_compile torrent_maker.py
        echo "âœ… è¯­æ³•éªŒè¯é€šè¿‡"
        
        echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯:"
        ls -lh torrent_maker.py
        wc -l torrent_maker.py
    
    - name: Generate release notes
      if: steps.version.outputs.should_release == 'true'
      id: release_notes
      run: |
        VERSION="v${{ steps.version.outputs.version }}"
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜
        VERSION="v${{ steps.version.outputs.version }}"
        
        # åˆ›å»ºå‘å¸ƒè¯´æ˜æ–‡ä»¶
        echo "## ğŸš€ Torrent Maker $VERSION" > release_notes.md
        echo "" >> release_notes.md
        echo "### âœ¨ æ–°ç‰ˆæœ¬å‘å¸ƒ" >> release_notes.md
        echo "- æ€§èƒ½ä¼˜åŒ–å’ŒåŠŸèƒ½æ”¹è¿›" >> release_notes.md
        echo "- ä¿®å¤å·²çŸ¥é—®é¢˜" >> release_notes.md
        echo "- æå‡ç”¨æˆ·ä½“éªŒ" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸ“¥ å¿«é€Ÿå¼€å§‹" >> release_notes.md
        echo "" >> release_notes.md
        echo "### æ–¹å¼ä¸€ï¼šä¸€é”®å®‰è£…ï¼ˆæ¨èï¼‰" >> release_notes.md
        echo '```bash' >> release_notes.md
        echo 'curl -fsSL https://raw.githubusercontent.com/Yan-nian/torrent-maker/main/scripts/install.sh | bash' >> release_notes.md
        echo '```' >> release_notes.md
        echo "" >> release_notes.md
        echo "### æ–¹å¼äºŒï¼šç›´æ¥ä¸‹è½½" >> release_notes.md
        echo '```bash' >> release_notes.md
        echo '# ä¸‹è½½å•æ–‡ä»¶ç‰ˆæœ¬' >> release_notes.md
        echo "curl -O https://github.com/Yan-nian/torrent-maker/releases/download/$VERSION/torrent_maker.py" >> release_notes.md
        echo "" >> release_notes.md
        echo '# ç›´æ¥è¿è¡Œ' >> release_notes.md
        echo 'python3 torrent_maker.py' >> release_notes.md
        echo '```' >> release_notes.md
        echo "" >> release_notes.md
        echo "### æ–¹å¼ä¸‰ï¼šGit å…‹éš†" >> release_notes.md
        echo '```bash' >> release_notes.md
        echo 'git clone https://github.com/Yan-nian/torrent-maker.git' >> release_notes.md
        echo 'cd torrent-maker' >> release_notes.md
        echo 'python3 torrent_maker.py' >> release_notes.md
        echo '```' >> release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸ“‹ ç³»ç»Ÿè¦æ±‚" >> release_notes.md
        echo "- **Python**: 3.7+ (æ¨è 3.9+)" >> release_notes.md
        echo "- **mktorrent**: å¿…éœ€çš„ç§å­åˆ›å»ºå·¥å…·" >> release_notes.md
        echo "- **å†…å­˜**: 512MB+ (æ¨è 1GB+)" >> release_notes.md
        echo "- **å­˜å‚¨**: 10MB (å•æ–‡ä»¶ç‰ˆæœ¬)" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸ”§ å®‰è£… mktorrent" >> release_notes.md
        echo "- **macOS**: \\`brew install mktorrent\\`" >> release_notes.md
        echo "- **Ubuntu/Debian**: \\`sudo apt install mktorrent\\`" >> release_notes.md
        echo "- **CentOS/RHEL**: \\`sudo yum install mktorrent\\`" >> release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸŒ æ”¯æŒå¹³å°" >> release_notes.md
        echo "- âœ… macOS (å®Œå…¨æ”¯æŒ)" >> release_notes.md
        echo "- âœ… Linux (Ubuntu, Debian, CentOS, RHEL)" >> release_notes.md
        echo "- âœ… Windows (WSL ç¯å¢ƒ)" >> release_notes.md
        echo "" >> release_notes.md
        echo "---" >> release_notes.md
        echo "" >> release_notes.md
        echo "ğŸ’¡ **æç¤º**: è¿™æ˜¯è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬ï¼ŒåŒ…å«æœ€æ–°åŠŸèƒ½å’Œä¿®å¤ï¼Œå¼€ç®±å³ç”¨ï¼" >> release_notes.md
        
        echo "ğŸ“ Release notes å·²ç”Ÿæˆ"
    
    - name: Create release package
      if: steps.version.outputs.should_release == 'true'
      run: |
        VERSION="v${{ steps.version.outputs.version }}"
        echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…..."
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
        cp torrent_maker.py release/
        cp scripts/install.sh release/
        cp README.md release/
        cp requirements.txt release/
        cp LICENSE release/
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd release
        tar -czf "torrent-maker-$VERSION.tar.gz" *
        cd ..
        
        echo "âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"
        ls -la release/
    
    - name: Create Git tag
      if: steps.version.outputs.should_release == 'true'
      run: |
        VERSION="v${{ steps.version.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git tag -a "$VERSION" -m "Auto Release $VERSION"
        git push origin "$VERSION"
        
        echo "ğŸ·ï¸ æ ‡ç­¾ $VERSION å·²åˆ›å»º"
    
    - name: Create GitHub Release
      if: steps.version.outputs.should_release == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: ğŸš€ Torrent Maker v${{ steps.version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          torrent_maker.py
          scripts/install.sh
          README.md
          requirements.txt
          LICENSE
          release/torrent-maker-v${{ steps.version.outputs.version }}.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notify completion
      if: steps.version.outputs.should_release == 'true'
      run: |
        VERSION="v${{ steps.version.outputs.version }}"
        echo "ğŸ‰ è‡ªåŠ¨å‘å¸ƒå®Œæˆï¼"
        echo "ğŸ“‹ ç‰ˆæœ¬: $VERSION"
        echo "ğŸ”— Release: https://github.com/Yan-nian/torrent-maker/releases/tag/$VERSION"
        echo "ğŸ“¥ å®‰è£…å‘½ä»¤: curl -fsSL https://raw.githubusercontent.com/Yan-nian/torrent-maker/main/scripts/install.sh | bash"
    
    - name: Skip notification
      if: steps.version.outputs.should_release == 'false'
      run: |
        VERSION="v${{ steps.version.outputs.version }}"
        echo "â„¹ï¸ ç‰ˆæœ¬ $VERSION å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
        echo "ğŸ”— ç°æœ‰ Release: https://github.com/Yan-nian/torrent-maker/releases/tag/$VERSION"