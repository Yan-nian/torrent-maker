name: Auto Release

# ç›‘æµ‹ç‰ˆæœ¬å˜æ›´è‡ªåŠ¨å‘å¸ƒ
on:
  push:
    branches: [ main ]
    paths: [ 'torrent_maker.py' ]

# è®¾ç½®æƒé™
permissions:
  contents: write
  pull-requests: read

jobs:
  auto-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬æ¯”è¾ƒ
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Extract and validate version
      id: version
      run: |
        # æå–å½“å‰ç‰ˆæœ¬å·
        CURRENT_VERSION=$(grep -E '^VERSION\s*=\s*"v[0-9]+\.[0-9]+\.[0-9]+"' torrent_maker.py | sed -E 's/.*"v([0-9]+\.[0-9]+\.[0-9]+)".*/\1/' | head -1)
        
        if [ -z "$CURRENT_VERSION" ]; then
          echo "âŒ æ— æ³•æå–ç‰ˆæœ¬å·"
          exit 1
        fi
        
        echo "ğŸ“‹ æ£€æµ‹åˆ°ç‰ˆæœ¬: v$CURRENT_VERSION"
        
        # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        if git tag | grep -q "^v$CURRENT_VERSION$"; then
          echo "âš ï¸ ç‰ˆæœ¬ v$CURRENT_VERSION å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
          echo "should_release=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸš€ æ–°ç‰ˆæœ¬æ£€æµ‹: v$CURRENT_VERSIONï¼Œå‡†å¤‡å‘å¸ƒ"
          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        fi
    
    - name: Validate torrent_maker.py
      if: steps.version.outputs.should_release == 'true'
      run: |
        echo "ğŸ” éªŒè¯ torrent_maker.py è¯­æ³•..."
        python3 -m py_compile torrent_maker.py
        echo "âœ… è¯­æ³•éªŒè¯é€šè¿‡"
        
        echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯:"
        ls -lh torrent_maker.py
        wc -l torrent_maker.py
    
    - name: Generate release notes
      if: steps.version.outputs.should_release == 'true'
      id: release_notes
      run: |
        VERSION="v${{ steps.version.outputs.version }}"
        
        # ä» torrent_maker.py æå–ç‰ˆæœ¬è¯´æ˜
        RELEASE_NOTES=$(python3 -c "
import re
with open('torrent_maker.py', 'r', encoding='utf-8') as f:
    content = f.read()
    
# æå–ç‰ˆæœ¬æè¿°
version_pattern = r'ğŸ¯ v${{ steps.version.outputs.version }}[^ğŸ¯]*?(?=ğŸ¯|$)'
match = re.search(version_pattern, content, re.DOTALL)
if match:
    print(match.group(0).strip())
else:
    print('## ğŸš€ Torrent Maker $VERSION\n\n### âœ¨ æ–°ç‰ˆæœ¬å‘å¸ƒ\n- æ€§èƒ½ä¼˜åŒ–å’ŒåŠŸèƒ½æ”¹è¿›\n- ä¿®å¤å·²çŸ¥é—®é¢˜\n- æå‡ç”¨æˆ·ä½“éªŒ')
")
        
        # æ·»åŠ ä¸‹è½½è¯´æ˜
        cat << EOF > release_notes.md
$RELEASE_NOTES

## ğŸ“¥ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šä¸€é”®å®‰è£…ï¼ˆæ¨èï¼‰
\`\`\`bash
curl -fsSL https://raw.githubusercontent.com/Yan-nian/torrent-maker/main/scripts/install.sh | bash
\`\`\`

### æ–¹å¼äºŒï¼šç›´æ¥ä¸‹è½½
\`\`\`bash
# ä¸‹è½½å•æ–‡ä»¶ç‰ˆæœ¬
curl -O https://github.com/Yan-nian/torrent-maker/releases/download/$VERSION/torrent_maker.py

# ç›´æ¥è¿è¡Œ
python3 torrent_maker.py
\`\`\`

### æ–¹å¼ä¸‰ï¼šGit å…‹éš†
\`\`\`bash
git clone https://github.com/Yan-nian/torrent-maker.git
cd torrent-maker
python3 torrent_maker.py
\`\`\`

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚
- Python 3.7+
- mktorrent
- 512MB+ å†…å­˜

## ğŸ”§ å®‰è£… mktorrent
**macOS**: \`brew install mktorrent\`  
**Ubuntu/Debian**: \`sudo apt install mktorrent\`  
**CentOS/RHEL**: \`sudo yum install mktorrent\`

---

ğŸ’¡ **æç¤º**: å•æ–‡ä»¶ç‰ˆæœ¬åŒ…å«æ‰€æœ‰åŠŸèƒ½ï¼Œæ— éœ€é¢å¤–ä¾èµ–ï¼ŒçœŸæ­£çš„å¼€ç®±å³ç”¨ï¼
EOF
        
        echo "ğŸ“ Release notes å·²ç”Ÿæˆ"
    
    - name: Create release package
      if: steps.version.outputs.should_release == 'true'
      run: |
        VERSION="v${{ steps.version.outputs.version }}"
        echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…..."
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
        cp torrent_maker.py release/
        cp scripts/install.sh release/
        cp README.md release/
        cp requirements.txt release/
        cp LICENSE release/
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd release
        tar -czf "torrent-maker-$VERSION.tar.gz" *
        cd ..
        
        echo "âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"
        ls -la release/
    
    - name: Create Git tag
      if: steps.version.outputs.should_release == 'true'
      run: |
        VERSION="v${{ steps.version.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git tag -a "$VERSION" -m "Release $VERSION"
        git push origin "$VERSION"
        
        echo "ğŸ·ï¸ æ ‡ç­¾ $VERSION å·²åˆ›å»º"
    
    - name: Create GitHub Release
      if: steps.version.outputs.should_release == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: ğŸ¬ Torrent Maker v${{ steps.version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          torrent_maker.py
          scripts/install.sh
          README.md
          requirements.txt
          LICENSE
          release/torrent-maker-v${{ steps.version.outputs.version }}.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update installation script cache
      if: steps.version.outputs.should_release == 'true'
      run: |
        echo "ğŸ”„ è§¦å‘å®‰è£…è„šæœ¬ç¼“å­˜æ›´æ–°..."
        # è¿™é‡Œå¯ä»¥æ·»åŠ  CDN ç¼“å­˜åˆ·æ–°é€»è¾‘
        echo "âœ… å‘å¸ƒæµç¨‹å®Œæˆ"
    
    - name: Notify completion
      if: steps.version.outputs.should_release == 'true'
      run: |
        VERSION="v${{ steps.version.outputs.version }}"
        echo "ğŸ‰ è‡ªåŠ¨å‘å¸ƒå®Œæˆï¼"
        echo "ğŸ“‹ ç‰ˆæœ¬: $VERSION"
        echo "ğŸ”— Release: https://github.com/Yan-nian/torrent-maker/releases/tag/$VERSION"
        echo "ğŸ“¥ å®‰è£…: curl -fsSL https://raw.githubusercontent.com/Yan-nian/torrent-maker/main/scripts/install.sh | bash"