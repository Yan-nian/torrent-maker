name: Manual Release

# æ‰‹åŠ¨è§¦å‘å‘å¸ƒï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 2.0.1)'
        required: true
        type: string
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false
      draft:
        description: 'æ˜¯å¦åˆ›å»ºè‰ç¨¿ç‰ˆæœ¬'
        required: false
        type: boolean
        default: false

# è®¾ç½®æƒé™
permissions:
  contents: write
  pull-requests: read

jobs:
  manual-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Validate inputs
      id: validate
      run: |
        VERSION="${{ github.event.inputs.version }}"
        
        # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
        if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
          echo "âŒ ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯: $VERSION"
          echo "âœ… æ­£ç¡®æ ¼å¼: x.y.z (ä¾‹å¦‚: 2.0.1)"
          exit 1
        fi
        
        # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
        if git tag | grep -q "^v$VERSION$"; then
          echo "âš ï¸ ç‰ˆæœ¬ v$VERSION å·²å­˜åœ¨"
          echo "ğŸ“‹ ç°æœ‰æ ‡ç­¾:"
          git tag | grep "^v" | sort -V | tail -5
          exit 1
        fi
        
        echo "âœ… ç‰ˆæœ¬éªŒè¯é€šè¿‡: v$VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Check code version consistency
      run: |
        VERSION="${{ steps.validate.outputs.version }}"
        
        # æ£€æŸ¥ä»£ç ä¸­çš„ç‰ˆæœ¬å·
        CODE_VERSION=$(grep -E '^VERSION\s*=\s*"v[0-9]+\.[0-9]+\.[0-9]+"' torrent_maker.py | sed -E 's/.*"v([0-9]+\.[0-9]+\.[0-9]+)".*/\1/' | head -1)
        
        if [ "$CODE_VERSION" != "$VERSION" ]; then
          echo "âš ï¸ ç‰ˆæœ¬ä¸ä¸€è‡´:"
          echo "   è¾“å…¥ç‰ˆæœ¬: $VERSION"
          echo "   ä»£ç ç‰ˆæœ¬: $CODE_VERSION"
          echo ""
          echo "ğŸ’¡ å»ºè®®:"
          echo "   1. æ›´æ–° torrent_maker.py ä¸­çš„ VERSION å˜é‡"
          echo "   2. æˆ–ä½¿ç”¨ä»£ç ç‰ˆæœ¬ $CODE_VERSION è¿›è¡Œå‘å¸ƒ"
          echo ""
          echo "ğŸ”„ ç»§ç»­ä½¿ç”¨è¾“å…¥ç‰ˆæœ¬è¿›è¡Œå‘å¸ƒ..."
        else
          echo "âœ… ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"
        fi
    
    - name: Validate torrent_maker.py
      run: |
        echo "ğŸ” éªŒè¯ torrent_maker.py..."
        python3 -m py_compile torrent_maker.py
        echo "âœ… è¯­æ³•éªŒè¯é€šè¿‡"
        
        echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯:"
        ls -lh torrent_maker.py
        wc -l torrent_maker.py
    
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="v${{ steps.validate.outputs.version }}"
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜
        cat << EOF > release_notes.md
## ğŸš€ Torrent Maker $VERSION - æ‰‹åŠ¨å‘å¸ƒ

### âœ¨ ç‰ˆæœ¬ç‰¹æ€§
- é«˜æ€§èƒ½ç§å­åˆ¶ä½œå·¥å…·
- åŸºäº mktorrent çš„åŠè‡ªåŠ¨åŒ–æµç¨‹
- æ™ºèƒ½æœç´¢å’Œæ‰¹é‡å¤„ç†åŠŸèƒ½
- å®Œæ•´çš„ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### ğŸ“¥ å¿«é€Ÿå¼€å§‹

#### æ–¹å¼ä¸€ï¼šä¸€é”®å®‰è£…ï¼ˆæ¨èï¼‰
\`\`\`bash
curl -fsSL https://raw.githubusercontent.com/Yan-nian/torrent-maker/main/scripts/install.sh | bash
\`\`\`

#### æ–¹å¼äºŒï¼šç›´æ¥ä¸‹è½½
\`\`\`bash
# ä¸‹è½½å•æ–‡ä»¶ç‰ˆæœ¬
curl -O https://github.com/Yan-nian/torrent-maker/releases/download/$VERSION/torrent_maker.py

# ç›´æ¥è¿è¡Œ
python3 torrent_maker.py
\`\`\`

#### æ–¹å¼ä¸‰ï¼šGit å…‹éš†
\`\`\`bash
git clone https://github.com/Yan-nian/torrent-maker.git
cd torrent-maker
python3 torrent_maker.py
\`\`\`

### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
- **Python**: 3.7+ (æ¨è 3.9+)
- **mktorrent**: å¿…éœ€çš„ç§å­åˆ›å»ºå·¥å…·
- **å†…å­˜**: 512MB+ (æ¨è 1GB+)
- **å­˜å‚¨**: 10MB (å•æ–‡ä»¶ç‰ˆæœ¬)

### ğŸ”§ å®‰è£… mktorrent
- **macOS**: \`brew install mktorrent\`
- **Ubuntu/Debian**: \`sudo apt install mktorrent\`
- **CentOS/RHEL**: \`sudo yum install mktorrent\`

### ğŸŒ æ”¯æŒå¹³å°
- âœ… macOS (å®Œå…¨æ”¯æŒ)
- âœ… Linux (Ubuntu, Debian, CentOS, RHEL)
- âœ… Windows (WSL ç¯å¢ƒ)

---

ğŸ’¡ **æç¤º**: è¿™æ˜¯æ‰‹åŠ¨å‘å¸ƒç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼Œå¼€ç®±å³ç”¨ï¼
EOF
        
        echo "ğŸ“ Release notes å·²ç”Ÿæˆ"
    
    - name: Create release package
      run: |
        VERSION="v${{ steps.validate.outputs.version }}"
        echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…..."
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
        cp torrent_maker.py release/
        cp scripts/install.sh release/
        cp README.md release/
        cp requirements.txt release/
        cp LICENSE release/
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd release
        tar -czf "torrent-maker-$VERSION-manual.tar.gz" *
        cd ..
        
        echo "âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"
        ls -la release/
    
    - name: Create Git tag
      run: |
        VERSION="v${{ steps.validate.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git tag -a "$VERSION" -m "Manual Release $VERSION"
        git push origin "$VERSION"
        
        echo "ğŸ·ï¸ æ ‡ç­¾ $VERSION å·²åˆ›å»º"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.validate.outputs.version }}
        name: ğŸ¬ Torrent Maker v${{ steps.validate.outputs.version }} (Manual)
        body_path: release_notes.md
        draft: ${{ github.event.inputs.draft }}
        prerelease: ${{ github.event.inputs.prerelease }}
        files: |
          torrent_maker.py
          scripts/install.sh
          README.md
          requirements.txt
          LICENSE
          release/torrent-maker-v${{ steps.validate.outputs.version }}-manual.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Notify completion
      run: |
        VERSION="v${{ steps.validate.outputs.version }}"
        DRAFT="${{ github.event.inputs.draft }}"
        PRERELEASE="${{ github.event.inputs.prerelease }}"
        
        echo "ğŸ‰ æ‰‹åŠ¨å‘å¸ƒå®Œæˆï¼"
        echo "ğŸ“‹ ç‰ˆæœ¬: $VERSION"
        echo "ğŸ“ è‰ç¨¿: $DRAFT"
        echo "ğŸ§ª é¢„å‘å¸ƒ: $PRERELEASE"
        echo "ğŸ”— Release: https://github.com/Yan-nian/torrent-maker/releases/tag/$VERSION"
        
        if [ "$DRAFT" = "false" ] && [ "$PRERELEASE" = "false" ]; then
          echo "ğŸ“¥ å®‰è£…å‘½ä»¤: curl -fsSL https://raw.githubusercontent.com/Yan-nian/torrent-maker/main/scripts/install.sh | bash"
        fi